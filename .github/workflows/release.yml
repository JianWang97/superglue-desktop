name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'        
      - name: Install dependencies
        run: npm install

      - name: Build web application
        run: npm run build      
      - name: Build Electron installer
        run: |
          echo "å¼€å§‹æ„å»º Electron å®‰è£…åŒ…..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(Get-Location)"
          echo "ç¯å¢ƒå˜é‡ NODE_ENV: $env:NODE_ENV"
          npm run pack
          echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºç›®å½•..."
          if (Test-Path "pack-electron") {
            echo "âœ… pack-electron ç›®å½•å­˜åœ¨"
            Get-ChildItem -Path "pack-electron" | ForEach-Object { echo "  - $($_.Name)" }
          } else {
            echo "âŒ pack-electron ç›®å½•ä¸å­˜åœ¨"
          }
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_ENV: production

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $version = $env:GITHUB_REF -replace "refs/tags/", ""
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true        
      - name: Find installer file
        id: installer
        shell: pwsh
        run: |
          # åˆ—å‡ºæ•´ä¸ªå·¥ä½œåŒºç»“æ„ä»¥ä¾¿è°ƒè¯•
          echo "=== å·¥ä½œåŒºæ ¹ç›®å½•å†…å®¹ ==="
          Get-ChildItem -Path "." | ForEach-Object { echo $_.Name }
          echo "========================"
          
          # æ£€æŸ¥ pack-electron ç›®å½•æ˜¯å¦å­˜åœ¨
          if (Test-Path "pack-electron") {
            echo "=== pack-electron ç›®å½•å†…å®¹ ==="
            Get-ChildItem -Path "pack-electron" -Recurse | ForEach-Object { echo $_.FullName }
            echo "========================"
          } else {
            echo "âŒ pack-electron ç›®å½•ä¸å­˜åœ¨ï¼"
            
            # æŸ¥æ‰¾å¯èƒ½çš„è¾“å‡ºç›®å½•
            echo "=== æŸ¥æ‰¾æ‰€æœ‰ .exe æ–‡ä»¶ ==="
            Get-ChildItem -Path "." -Filter "*.exe" -Recurse | ForEach-Object { echo $_.FullName }
            echo "========================"
            
            # æ£€æŸ¥ packages/electron ç›®å½•
            if (Test-Path "packages/electron") {
              echo "=== packages/electron ç›®å½•å†…å®¹ ==="
              Get-ChildItem -Path "packages/electron" -Recurse | Where-Object { $_.Extension -eq ".exe" -or $_.Name -eq "dist" } | ForEach-Object { echo $_.FullName }
              echo "========================"
            }
          }
          
          # æŸ¥æ‰¾å®‰è£…åŒ…æ–‡ä»¶ï¼Œåœ¨å¤šä¸ªå¯èƒ½çš„ä½ç½®æŸ¥æ‰¾
          $searchPaths = @("pack-electron", "packages/electron/dist", "packages/electron", ".")
          $installerPath = $null
            foreach ($path in $searchPaths) {
            if (Test-Path $path) {
              $installerPath = Get-ChildItem -Path $path -Filter "*.exe" -Recurse | Where-Object { 
                -not $_.PSIsContainer -and (
                  $_.Name -match "(Setup|setup)" -or $_.Name -match "Superglue.*\.exe"
                )
              } | Select-Object -First 1
              
              if ($installerPath) {
                echo "âœ… åœ¨ $path ä¸­æ‰¾åˆ°å®‰è£…åŒ…: $($installerPath.FullName)"
                break
              }
            }
          }
            if ($installerPath) {
            # è·å–ç›¸å¯¹äºå·¥ä½œç›®å½•çš„è·¯å¾„
            $relativePath = Resolve-Path -Path $installerPath.FullName -Relative
            echo "installer_path=$relativePath" >> $env:GITHUB_OUTPUT
            echo "installer_name=$($installerPath.Name)" >> $env:GITHUB_OUTPUT
            echo "Found installer: $($installerPath.FullName)"
            echo "Relative path: $relativePath"
          } else {
            echo "âŒ æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶ï¼"
            echo "Available files:"
            Get-ChildItem -Path "." -Recurse | Where-Object { $_.Extension -eq ".exe" } | ForEach-Object { echo "  $($_.FullName)" }
            exit 1
          }
      - name: Verify installer file
        shell: pwsh
        run: |
          $installerPath = "${{ steps.installer.outputs.installer_path }}"
          echo "éªŒè¯å®‰è£…åŒ…æ–‡ä»¶: $installerPath"
          
          if (Test-Path $installerPath) {
            $item = Get-Item $installerPath
            if ($item.PSIsContainer) {
              echo "âŒ é”™è¯¯: $installerPath æ˜¯ä¸€ä¸ªç›®å½•ï¼Œä¸æ˜¯æ–‡ä»¶ï¼"
              exit 1
            } else {
              echo "âœ… æ–‡ä»¶éªŒè¯æˆåŠŸ: $($item.Name)"
              echo "æ–‡ä»¶å¤§å°: $([math]::Round($item.Length/1MB, 2)) MB"
            }
          } else {
            echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: $installerPath"
            exit 1
          }

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          files: ${{ steps.installer.outputs.installer_path }}

      - name: Generate Release Notes
        shell: pwsh
        run: |
          echo "ğŸ‰ Superglue Desktop ${{ steps.version.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
          echo ""
          echo "## ğŸ“¦ ä¸‹è½½"
          echo "- Windows å®‰è£…ç¨‹åº: ${{ steps.installer.outputs.installer_name }}"
          echo ""
          echo "## ğŸ”§ å®‰è£…è¯´æ˜"
          echo "1. ä¸‹è½½ Windows å®‰è£…ç¨‹åº"
          echo "2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰ç…§æç¤ºå®‰è£…"
          echo "3. å®‰è£…å®Œæˆåå¯åœ¨å¼€å§‹èœå•æˆ–æ¡Œé¢æ‰¾åˆ° Superglue å¿«æ·æ–¹å¼"
          echo ""
          echo "## âš ï¸ ç³»ç»Ÿè¦æ±‚"
          echo "- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬"
          echo "- x64 æ¶æ„"
